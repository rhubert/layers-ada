inherit: [make, gpr]
metaEnvironment:
   PD: "An Ada binding to D-Bus"
   LICENCE: "GPL-2.0-or-later WITH GMGPL"
   LICENCE_FILE: "/GMGPL.txt"
   PV: "0.6.2"

depends:
   - dbus::dbus-dev
   - dbus::dbus-glib-dev
   - use: []
     depends:
      - dbus::dbus-tgt
      - dbus::dbus-glib-tgt

checkoutSCM:
   scm: git
   url: https://git.codelabs.ch/dbus-ada.git
   branch: "master"
   commit: 944e09094cc861ff4c3f60fb9c79eca357df7b7c

buildTools: [gprbuild, target-toolchain]
buildVars: [AUTOCONF_HOST]
buildSetup: |
   build() {
     DBUS_ADA_DYNAMIC=$1
     shift

     rsync -a $1/ .
     mkdir -p install/usr/lib
     if [ $DBUS_ADA_DYNAMIC = "static" ]
     then
        sed -i "s/^VERSION = .*$/VERSION = ''/" Makefile
     fi
     export GNAT_BUILDER_FLAGS="-R -j$(nproc) --target=${AUTOCONF_HOST}"
     makeParallel
     makeSequential install PREFIX=$(pwd)/install/usr GPRINSTALLFLAGS="--target=${AUTOCONF_HOST} --prefix=$(pwd)/install/usr"
   }
multiPackage:
  "":
    buildScript: build static $*
    multiPackage:
       dev:
          provideDeps: ['*-dev']
          packageScript: gprInstallPackageDev
       tgt:
          provideDeps: ['*-tgt']
          packageScript: autotoolsPackageTgt
  dynamic:
    buildScript: build dynamic $*
    multiPackage:
      dev:
        provideDeps: ['*-dev']
        packageScript: gprInstallPackageDev
      tgt:
        provideDeps: ['*-tgt']
        packageScript: autotoolsPackageTgt
